<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Backyard Adventures</title>
    <link rel="stylesheet" href="../css/portal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <nav class="main-nav">
            <div class="logo">Backyard Adventures</div>
            <div class="nav-actions">
                <span id="userEmail"></span>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="dashboard-container">
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li class="active">
                    <a href="#overview">
                        <i class="fas fa-dashboard"></i> Overview
                    </a>
                </li>
                <li>
                    <a href="#bookings">
                        <i class="fas fa-calendar-check"></i> My Bookings
                    </a>
                </li>
                <li>
                    <a href="#rentals">
                        <i class="fas fa-ship"></i> My Rentals
                    </a>
                </li>
                <li>
                    <a href="#profile">
                        <i class="fas fa-user"></i> Profile
                    </a>
                </li>
            </ul>
        </aside>

        <section class="dashboard-content">
            <!-- Overview Section -->
            <div id="overview" class="dashboard-section active">
                <h1>Welcome, <span id="userName"></span>!</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-calendar-check"></i>
                        <h3 id="totalBookings">0</h3>
                        <p>Total Bookings</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-ship"></i>
                        <h3 id="totalRentals">0</h3>
                        <p>Total Rentals</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <h3 id="upcomingActivities">0</h3>
                        <p>Upcoming Activities</p>
                    </div>
                </div>

                <div class="quick-actions">
                    <h2>Quick Actions</h2>
                    <div class="action-buttons">
                        <a href="../tours.html" class="action-btn">
                            <i class="fas fa-compass"></i>
                            <span>Book a Tour</span>
                        </a>
                        <a href="../rentals.html" class="action-btn">
                            <i class="fas fa-water"></i>
                            <span>Rent Equipment</span>
                        </a>
                        <a href="../contact.html" class="action-btn">
                            <i class="fas fa-envelope"></i>
                            <span>Contact Us</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Bookings Section -->
            <div id="bookings" class="dashboard-section">
                <h1>My Tour Bookings</h1>
                <div id="bookingsList" class="bookings-list">
                    <p class="loading"><i class="fas fa-spinner fa-spin"></i> Loading bookings...</p>
                </div>
            </div>

            <!-- Rentals Section -->
            <div id="rentals" class="dashboard-section">
                <h1>My Equipment Rentals</h1>
                <div id="rentalsList" class="rentals-list">
                    <p class="loading"><i class="fas fa-spinner fa-spin"></i> Loading rentals...</p>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile" class="dashboard-section">
                <h1>My Profile</h1>
                <form id="profileForm" class="profile-form">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="full_name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" disabled>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" name="phone">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea name="address" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                </form>
            </div>
        </section>
    </main>

    <!-- Supabase Integration Scripts -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/supabase-auth.js"></script>
    <script src="../js/supabase-queries.js"></script>
    <script>
        let currentUser = null;
        let userProfile = null;

        // Initialize dashboard
        async function initDashboard() {
            // Check authentication
            const authenticated = await supabaseAuth.requireAuth();
            if (!authenticated) return;

            // Get current user
            currentUser = await supabaseHelpers.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Get user profile
            const profileResult = await supabaseAuth.getUserProfile(currentUser.id);
            if (profileResult.success) {
                userProfile = profileResult.profile;
                displayUserInfo();
                loadDashboardData();
            }
        }

        // Display user information
        function displayUserInfo() {
            document.getElementById('userEmail').textContent = userProfile.email;
            document.getElementById('userName').textContent = userProfile.full_name;
            
            // Populate profile form
            const form = document.getElementById('profileForm');
            form.full_name.value = userProfile.full_name || '';
            form.email.value = userProfile.email || '';
            form.phone.value = userProfile.phone || '';
            form.address.value = userProfile.address || '';
        }

        // Load dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadBookings(),
                loadRentals(),
                updateStats()
            ]);
        }

        // Load user bookings
        async function loadBookings() {
            const result = await supabaseQueries.getUserBookings(currentUser.id);
            const container = document.getElementById('bookingsList');
            
            if (result.success && result.data.length > 0) {
                container.innerHTML = result.data.map(booking => `
                    <div class="booking-card ${booking.status}">
                        <div class="booking-header">
                            <h3>${booking.tours.name}</h3>
                            <span class="status-badge ${booking.status}">${booking.status}</span>
                        </div>
                        <div class="booking-details">
                            <p><i class="fas fa-calendar"></i> ${supabaseHelpers.formatDate(booking.date)}</p>
                            <p><i class="fas fa-users"></i> ${booking.participants} participants</p>
                            <p><i class="fas fa-dollar-sign"></i> ${supabaseHelpers.formatCurrency(booking.total_price)}</p>
                        </div>
                        ${booking.status === 'pending' || booking.status === 'confirmed' ? `
                            <button class="cancel-btn" onclick="cancelBooking('${booking.id}')">
                                <i class="fas fa-times"></i> Cancel Booking
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="no-data">No bookings found. <a href="../tours.html">Book a tour now!</a></p>';
            }
        }

        // Load user rentals
        async function loadRentals() {
            const result = await supabaseQueries.getUserRentals(currentUser.id);
            const container = document.getElementById('rentalsList');
            
            if (result.success && result.data.length > 0) {
                container.innerHTML = result.data.map(rental => `
                    <div class="rental-card ${rental.status}">
                        <div class="rental-header">
                            <h3>${rental.equipment.name}</h3>
                            <span class="status-badge ${rental.status}">${rental.status}</span>
                        </div>
                        <div class="rental-details">
                            <p><i class="fas fa-calendar-alt"></i> ${supabaseHelpers.formatDate(rental.start_date)} - ${supabaseHelpers.formatDate(rental.end_date)}</p>
                            <p><i class="fas fa-clock"></i> ${rental.duration_hours} hours</p>
                            <p><i class="fas fa-dollar-sign"></i> ${supabaseHelpers.formatCurrency(rental.total_price)}</p>
                        </div>
                        ${rental.status === 'pending' || rental.status === 'active' ? `
                            <button class="cancel-btn" onclick="cancelRental('${rental.id}', '${rental.equipment_id}')">
                                <i class="fas fa-times"></i> Cancel Rental
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="no-data">No rentals found. <a href="../rentals.html">Rent equipment now!</a></p>';
            }
        }

        // Update statistics
        async function updateStats() {
            const [bookingsResult, rentalsResult] = await Promise.all([
                supabaseQueries.getUserBookings(currentUser.id),
                supabaseQueries.getUserRentals(currentUser.id)
            ]);

            if (bookingsResult.success) {
                document.getElementById('totalBookings').textContent = bookingsResult.data.length;
                const upcoming = bookingsResult.data.filter(b => 
                    new Date(b.date) > new Date() && (b.status === 'pending' || b.status === 'confirmed')
                ).length;
                document.getElementById('upcomingActivities').textContent = upcoming;
            }

            if (rentalsResult.success) {
                document.getElementById('totalRentals').textContent = rentalsResult.data.length;
            }
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;

            const result = await supabaseQueries.cancelBooking(bookingId);
            if (result.success) {
                supabaseHelpers.showNotification('Booking cancelled successfully', 'success');
                loadBookings();
                updateStats();
            } else {
                supabaseHelpers.showNotification('Failed to cancel booking', 'error');
            }
        }

        // Cancel rental
        async function cancelRental(rentalId, equipmentId) {
            if (!confirm('Are you sure you want to cancel this rental?')) return;

            const result = await supabaseQueries.cancelRental(rentalId, equipmentId);
            if (result.success) {
                supabaseHelpers.showNotification('Rental cancelled successfully', 'success');
                loadRentals();
                updateStats();
            } else {
                supabaseHelpers.showNotification('Failed to cancel rental', 'error');
            }
        }

        // Handle profile update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const updates = {
                full_name: formData.get('full_name'),
                phone: formData.get('phone'),
                address: formData.get('address')
            };

            const result = await supabaseAuth.updateUserProfile(currentUser.id, updates);
            if (result.success) {
                supabaseHelpers.showNotification('Profile updated successfully', 'success');
                userProfile = { ...userProfile, ...updates };
                displayUserInfo();
            } else {
                supabaseHelpers.showNotification('Failed to update profile', 'error');
            }
        });

        // Handle logout
        async function handleLogout() {
            const result = await supabaseAuth.signOut();
            if (result.success) {
                window.location.href = 'login.html';
            }
        }

        // Navigation handling
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.currentTarget.getAttribute('href').substring(1);
                
                // Update active states
                document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
                e.currentTarget.parentElement.classList.add('active');
                
                document.querySelectorAll('.dashboard-section').forEach(section => section.classList.remove('active'));
                document.getElementById(target).classList.add('active');
            });
        });

        // Initialize on page load
        initDashboard();
    </script>
</body>
</html>
